# Тестовое задание на должность "Разработчик NodeJS"
## Запуск микросервисов и RabbitMQ

### 1) Запуск контейнера RabbitMQ
```
docker-compose up -d
```

### 2) Запуск мимкросервиса М1
```
pnpm build
pnpm start
```

### 3) Запуск мимкросервиса М2
```
pnpm build
pnpm start
```
### Примечание:
```
Запуск микросервисов М1 и М2 нужно производить после запуска RabbitMQ.
Для запуска RabbitMQ создн Docker Compose файл, дополнительно включена возможность работы с логами Loki и Promtail.
Promtail снимает логи с контейнера RabbitMQ
Loki получает логи, с его помощью можно визуализировать логи в Grafana
```

Микросервисы М1 и М2 написаны на Node.js и используют библиотеку AMQP для работы с RabbitMQ.

## Описание
Для упрощения примера, допустим, что обработка заказов заключается в генерации подтверждения заказа с уникальным номером. 

### Получение данных заказа: 
При получении запроса метод извлекает данные заказа из тела запроса.

### Создание каналов и очередей:
 Вызывается функция createChannelAndQueue, которая создает соединение с RabbitMQ и канал для отправки заказов, а также канал для получения подтверждений от M2.

### Отправка заказа в очередь: 
Данные заказа, полученные из запроса, отправляются в соответствующую очередь RabbitMQ с помощью метода sendToQueue.

### Прием подтверждений от M2: 
Запускается обработчик для подтверждений от M2. Как только сообщение появляется в очереди подтверждений, оно обрабатывается, и информация о подтверждении выводится в лог. После обработки подтверждения вызывается метод ack(), чтобы сообщить RabbitMQ о том, что сообщение было успешно обработано и может быть удалено из очереди.

### Ответ на запрос: 
В ответ на запрос создания заказа отправляется ответ с сообщением "Order created and sent for processing" и статусом 200.

### Логгирование ошибок: 
Если в ходе выполнения возникает ошибка (например, при создании соединения с RabbitMQ или при обработке подтверждений), ошибка логгируется с помощью pino, и отправляется ответ с ошибкой "Internal Server Error" и статусом 500.
Логгирование можно визуализировать в Grafana используя Loki. 
Метрики можно посмотреть по адресу:
`http://localhost:3100/metrics`
Для высоконагруженных систем лучше использовать ELK.

### Запуск сервера: 
В конце кода метод start() запускает сервер на порту 3001. В случае успешного запуска, выводится сообщение "Server listening on port http://localhost:3001". Если запуск не удался, выводится сообщение об ошибке.

В результате, метод POST /create-order отправляет данные заказа в RabbitMQ для обработки микросервисом M2 и ожидает подтверждения от M2. Затем он возвращает ответ клиенту о создании заказа и отправке на обработку.

## Напимер
При отправке запроса:
```
curl -X POST -H "Content-Type: application/json" -d '{"order": "example1"}' http://localhost:3001/create-order
```


Микросервис М1 транслирует HTTP асинхронный запрос в очередь RabbitMQ.
Обрабатываем задание микросервисом М2 из очереди RabbitMQ.
```
{"level":30,"time":1692522889810,"pid":174737,"hostname":"sx038iubu-H81M-D2V","msg":"Order processed. Confirmation number: CONF-bjj0jjfb8 order Data M1 {\"order\":\"example1\"}"}
```

Помещаем результат обработки задания в RabbitMQ.
Возвращаем результат HTTP запроса как результат выполнения задания из RabbitMQ.
в микросервисе М1 выведется сообщение, что получено подтверждение от M2 вместе с генерацией подтверждения заказа CONF-bjj0jjfb8

```
{"level":30,"time":1692522889811,"pid":178374,"hostname":"sx038iubu-H81M-D2V","msg":"Received confirmation from M2: CONF-bjj0jjfb8"}
```